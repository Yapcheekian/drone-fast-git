#!/bin/bash

set -ex

WORKDIR=`pwd`
LOCAL_REPO="/var/git_local/$DRONE_REPO_NAME"

echo "Workspace: $WORKDIR"
echo "Local cahched repo path: $LOCAL_REPO"

if [[ -d $LOCAL_REPO/.git ]]; then
    echo 'Local cached git repo exists.'
else
    echo 'Local cached git repo dose not exist. Start cloning from remote...'
    git clone $DRONE_GIT_HTTP_URL $LOCAL_REPO
    echo 'Done.'
fi

echo 'Update local cahched repo...'
cd $LOCAL_REPO
git fetch --all
echo 'Done.'

echo 'Checkout commit from local cahched repo...'
cd $WORKDIR

if [[ -d $WORKDIR/.git ]]; then
    git fetch --all
else
    git clone $DRONE_GIT_HTTP_URL $LOCAL_REPO
fi

git checkout $DRONE_COMMIT
echo 'Done.'
